package in.ankit.services;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;

import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import in.ankit.admin.entity.PlansEntity;
import in.ankit.admin.repo.PlansRepo;
import in.ankit.appreg.entities.AppEntity;
import in.ankit.appreg.repos.AppRepo;
import in.ankit.datacollection.bindings.DcSummary;
import in.ankit.datacollection.bindings.EducationForm;
import in.ankit.datacollection.bindings.IncomeForm;
import in.ankit.datacollection.bindings.KidForm;
import in.ankit.datacollection.bindings.Kids;
import in.ankit.datacollection.bindings.PlanSelForm;
import in.ankit.datacollection.entities.EducationEntity;
import in.ankit.datacollection.entities.IncomeEntity;
import in.ankit.datacollection.entities.KidEntity;
import in.ankit.datacollection.entities.PlanSelEntity;
import in.ankit.datacollection.repo.EducationRepo;
import in.ankit.datacollection.repo.IncomeRepo;
import in.ankit.datacollection.repo.KidRepo;
import in.ankit.datacollection.repo.PlanSelRepo;

@Service
public class DcServiceImpl implements DcService {
     
	@Autowired
	private PlansRepo planRepo;
	
	@Autowired
	private PlanSelRepo planSelRepo;
	
	@Autowired
	private IncomeRepo incomeRepo;
	
	@Autowired
	private EducationRepo educationSelRepo;
	
	@Autowired
	private KidRepo kidRepo;
	
	@Autowired
	private AppRepo appRepo;
	
		
	@Override
	public Map<Integer, String> getPlans() {
		
		Map<Integer,String> plansMap = new HashMap<>();
		List<PlansEntity> entities = planRepo.findAll();
		
		for(PlansEntity entity: entities) {
			plansMap.put(entity.getPlanId(), entity.getPlanName());			
		}
		return plansMap;
	}
	

	@Override
	public boolean savePlanSelection(PlanSelForm planSel) {
		PlanSelEntity entity = new PlanSelEntity();
		BeanUtils.copyProperties(planSel, entity);
		
		planSelRepo.save(entity);
		
		return entity.getPlanSelId()>0;
	}
	

	@Override
	public boolean saveIncome(IncomeForm income) {	
		IncomeEntity entity = new IncomeEntity();
		BeanUtils.copyProperties(income, entity);
		incomeRepo.save(entity);
		return entity.getIncomeId()>0;
	}

	@Override
	public boolean saveEducation(EducationForm education) {
		EducationEntity entity = new EducationEntity();
		BeanUtils.copyProperties(education, entity);
		educationSelRepo.save(entity);
		
		return entity.getEducationId()>0;
	}

	@Override
	public boolean saveKids(Kids kids) {
		List<KidForm> kidsList = kids.getKidsList();
		
		for(KidForm kid : kidsList) {
			KidEntity entity = new KidEntity();
			BeanUtils.copyProperties(kid, entity);
			kidRepo.save(entity);
		}
		return true;
	}

	@Override
	public DcSummary fetchSummaryInfo(Long caseNum) {
		DcSummary summary = new DcSummary();		
		
		Optional<AppEntity> byId = appRepo.findById(caseNum);
		if(byId.isPresent()) {
			AppEntity appEntity = byId.get();
            
			EducationEntity educationEntity = appEntity.getEducation();
			EducationForm education = new EducationForm();
			BeanUtils.copyProperties(educationEntity, education);
			
			List<KidEntity> kidsEntity = appEntity.getKid();
			Kids kids = new Kids();
			BeanUtils.copyProperties(kidsEntity, kids);

						
			IncomeEntity incomeEntity = appEntity.getIncome();
			IncomeForm income = new IncomeForm();
			BeanUtils.copyProperties(incomeEntity, income);
			
			//TODO: Set data to summary object.
			
			summary.setEducation(education);
			summary.setIncome(income);
			summary.setKids(kids);

		}
		return summary;
	}

}
